# Verilog-Vivado2018.3-elevator_controller-for-CQU-final
CQU数电期末项目——电梯控制器（5层）的设计

所有代码都写在Elevator.v文件里，我使用的是Vivado2018.3版本，开发版为Basys3. 如果打不开项目请直接导入Elevator.v文件，然后根据自己的开发版设置引脚。

# 实验过程
1. 逻辑实现：
按键检测逻辑
针对每个楼层按键（key1 - key5）都有独立且相似的按键检测逻辑。以key1为例，在always @(posedge clk_1s_q or posedge rst)块中，复位时将key1_sync初始化为0，key1_last也初始化为0。正常运行时，先把当前的key1_sync值赋给key1_last（用于保存上一时刻的按键同步值），再将外部输入的key1按键值赋给key1_sync，通过assign key1_detected = (~key1_last & key1_sync);这样的语句来检测按键按下的上升沿（即上一时刻为低电平，当前时刻为高电平），其他key2 - key5按键的检测逻辑同理，最终每个按键都有对应的检测信号（如key2_detected等）来表示该按键是否被按下。
楼层状态管理逻辑
在always @(posedge clk_1s_q or posedge rst)块中，复位时current_floor_q被设置为表示1楼的3'd1。在正常运行且非复位情况下，如果电梯处于向上运行（state_q==STATE_UPWARD）并且检测到上方有楼层按键被按下（通过detected_upper_floor信号判断），则当前楼层current_floor_q会递增，表示电梯向上移动一层；同理，当电梯处于向下运行（state_q==STATE_DOWNWARD）且检测到下方有楼层按键按下（通过detected_lower_floor信号判断）时，current_floor_q会递减，表示电梯向下移动一层，以此来实时跟踪电梯所在的楼层位置。
向上、向下楼层检测
通过一个case语句根据当前楼层current_floor_q来判断是否有上方楼层按键被按下。例如当在1楼时，只要detected_floor_q中代表2楼及以上楼层按键按下情况的位有高电平（即有请求），则表示检测到上方楼层有请求；在其他楼层时也按照相应规则判断，5楼时则始终为0，因为已经是最高楼层了，不存在向上的请求了。同样用case语句按照当前楼层判断下方楼层的按键请求情况，1楼时始终为0，因为是最低楼层不存在向下请求了。
状态寄存器更新
在always @ (posedge clk_1s_q or posedge rst)块中，复位时将状态寄存器state_q设置为初始的停止状态（STATE_STOP），正常运行时将其更新为下一个状态（next_state）的值，以此来实现状态的逐周期更新。
状态转移逻辑
在always @ ()块中，通过case语句根据当前状态来决定下一个状态。
在STATE_STOP状态下，如果当前楼层不是5楼且检测到上方楼层有请求，则下一个状态切换为向上运行状态；如果当前楼层不是1楼且检测到下方楼层有请求，则切换为向下运行状态；否则保持在停止状态。
在STATE_UPWARD状态中，如果当前楼层有按键请求，则下一个状态切换到向上停止状态；如果上方还有楼层请求，则继续保持向上运行状态；若都不满足则回到停止状态。
在STATE_UPWARD_STOP状态下，当3秒停留时间计时满，就回到向上运行状态。
在STATE_DOWNWARD状态里，类似STATE_UPWARD状态的判断逻辑，当前楼层有请求就切换到向下停止状态，下方还有请求就继续向下运行，否则回到停止状态。
在STATE_DOWNWARD_STOP状态下，同样当3秒计时满就回到向下运行状态。
通过这样的状态转移逻辑，实现了电梯根据不同楼层按键请求以及当前运行状态来合理切换运行状态，模拟了实际电梯的运行控制逻辑。
2. 功能测试步骤：
按键功能测试：从 1 楼按键开始，依次按下每个楼层的按键，观察数码管是否正确显示对应的楼层数字，相应楼层请求的 LED 灯是否亮起，同时关注状态机状态的变化情况，验证电梯控制逻辑对于按键请求的响应是否符合设计预期。例如，按下 3 楼按键时，对应的 key3_detected 信号应产生脉冲，若当前电梯处于停止状态且不在 3 楼，状态机应响应此请求，并且数码管和 LED 灯显示要相应更新。
状态转移测试：在电梯运行过程中，继续按下其他楼层按键，观察状态机是否能根据当前楼层、已有请求以及运行方向等因素正确地进行状态转移，比如在向上运行过程中遇到当前楼层有请求时能否正确进入停止状态并停留相应时间，然后再继续正确运行。
边界情况测试：针对5 楼和1 楼的特殊情况进行测试，如在 5 楼时按下向上按键或者在 1 楼时按下向下按键，验证系统是否能正确处理这些边界请求，相应的 LED 灯能否符合预期。

电梯可以正确响应多个楼层并有逻辑地处理楼层到达顺序，到达楼层后呼叫状态自动消除，楼层对应的LED灯自动熄灭，数码管显示楼层数正确，到达顶层5楼后呼叫1楼不会直接跳转，而是按照5->4->3->2->1的顺序到达。按键可以正确响应取消呼叫操作，取消后电梯停止运行。

# p.s.
1.目前版本如果遇到多个楼层请求，虽然到达楼层后消除，但是顺序存在先后问题，应对期末应该是没有问题，有耐心的朋友可以自行debug...^_^
2.按键消抖部分和时钟分频部分有点粗糙，导致在开发板上按下一个按键需要轻微长按（1s左右），大家可以自行调整（我因为是赶工完成所以各个方面都比较粗糙。。。）

最后，祝各位期末满绩:-)
